# metrixd

`metrixd` — Prometheus-экспортер на Go. Он публикует стандартные метрики Go и процесса, а также пользовательский gauge `host_environment_info`, показывающий, запускается ли процесс в контейнере, виртуальной машине или на «голом» железе. Сервис предназначен для развёртывания через Ansible как служба systemd на гостевой системе Rocky Linux. Репозиторий содержит исходный код Go и роль Ansible для установки.

## Содержимое

* `main.go` — исходный код экспортёра.
* `go.mod` — описание Go-модуля с зависимостью от Prometheus.
* `Makefile` — цели для сборки статического бинарника под Linux (arm64/amd64) с размещением его в роли Ansible.
* `roles/metrixd/` — роль Ansible: устанавливает бинарник как службу systemd, применяет разумный hardening и проверяет HTTP-эндпоинт.
* `site.yml` и `ansible.cfg` — простой плейбук и конфигурация Ansible, подключающие роль.
* `inventories/hosts.yml` — пример инвентаря, указывающий на контейнер orbstack (с UTM работало бы также).

## Сборка бинарника

В корне репозитория выполните:

```sh
make build-linux-arm64    # для Rocky Linux на ARM64 (например, UTM на Apple Silicon)
```

или, если гость — архитектуры x86_64:

```sh
make build-linux-amd64
```

Собранный бинарник будет помещён в `roles/metrixd/files/metrixd` и помечен как исполняемый.

## Развёртывание с помощью Ansible

После сборки бинарника запустите плейбук на вашем хосте Rocky Linux:

```sh
ansible-playbook -i inventories/hosts.yml site.yml
```

Роль выполняет следующие шаги идемпотентно:

1. Создаёт выделённых сервисных пользователя и группу.
2. Копирует бинарник `metrixd` в `/opt/metrixd`.
3. Устанавливает unit-файл systemd.
4. Включает и запускает службу.
5. Ожидает HTTP-статус 200 на `http://127.0.0.1:8080` и проверяет наличие строки `host_environment_info{type=...}` в теле ответа.

По умолчанию служба слушает только `127.0.0.1:8080`, чтобы не выставлять метрики наружу. При необходимости можно переопределить адрес привязки переменной `metrixd_listen_addr` в `inventories/hosts.yml` или с помощью `--extra-vars`.
